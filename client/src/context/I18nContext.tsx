import React, { createContext, useCallback, useContext, useMemo, useState } from 'react';

type Locale = 'en' | 'vi' | 'es' | 'fr' | 'ja' | 'ko';

type I18nContextValue = {
  locale: Locale;
  setLocale: (l: Locale) => void;
  available: Locale[];
  t: (messageEn: string, params?: Record<string, any>) => string;
};

// Legacy map: Vietnamese -> English
const legacyViToEn: Record<string, string> = {
  'Kích thước tile': 'Tile size',
  'Kích thước lớn': 'Large size',
  'Giảm kích thước tile': 'Decrease tile width',
  'Tăng kích thước tile': 'Increase tile width',
  'Độ rộng view': 'Viewer width',
  'Giảm độ rộng view': 'Decrease viewer width',
  'Tăng độ rộng view': 'Increase viewer width',
  'Chiều cao tile: {height}px (Tự tính theo độ rộng)': 'Tile height: {height}px (Auto from width)',
  'Cấu hình stream (viewer)': 'Stream config (viewer)',
  'Cấu hình stream': 'Stream config',
  'Chiều rộng stream': 'Stream width',
  'Giảm chiều rộng stream': 'Decrease stream width',
  'Tăng chiều rộng stream': 'Increase stream width',
  'Giảm bitrate': 'Decrease bitrate',
  'Tăng bitrate': 'Increase bitrate',
  'Giảm FPS': 'Decrease FPS',
  'Tăng FPS': 'Increase FPS',
  'Cục bộ': 'Local',
  'Trực tuyến': 'Online',
  'Tất cả': 'All',
  'Thẻ điện thoại': 'Device tags',
  'Thêm thẻ': 'Add tag',
  'Select all': 'Select all',
  'Deselect all': 'Deselect all',
  'Mở rộng bảng cấu hình': 'Expand config panel',
  'Độ rộng tile: {width}px': 'Tile width: {width}px',
  'Chiều cao tile: {height}px': 'Tile height: {height}px',
  'Bitrate: {bps} bps': 'Bitrate: {bps} bps',
  'FPS tối đa: {fps} fps': 'Max FPS: {fps} fps',
  'Chiều rộng stream: {width}px': 'Stream width: {width}px',
  'Chiều cao stream: {height}px': 'Stream height: {height}px',
  'Khóa xoay:': 'Rotated orientation:',
  'Đặt lại mặc định': 'Reset default',
  'Bitrate cao': 'High bitrate',
  'Kéo bitrate cao trên (60%) có thể làm tăng tải và đôi lúc gây giật/đứt stream. Vẫn tiếp tục?':
    'High bitrate (>60%) may increase load and cause stutter/interruptions. Continue?',
  'Hủy': 'Cancel',
  'Tiếp tục': 'Continue',
  'Chọn device trước khi cài APK': 'Pick a device before installing APK',
  'Đang upload {name}...': 'Uploading {name}...',
  'Đã lưu lên server: {name}, đang cài...': 'Saved to server: {name}, installing...',
  'Đã cài: {name}': 'Installed: {name}',
  'Cài/Upload APK thất bại': 'Install/Upload APK failed',
  'Sync đang bật: gửi thao tác tới tất cả thiết bị đang mở': 'Sync on: send actions to all open devices',
  'Sync đang tắt: chỉ điều khiển thiết bị đang focus': 'Sync off: control only the focused device',
  'Dừng sync': 'Stop sync',
  'Nguồn': 'Power',
  'Tăng âm lượng': 'Vol +',
  'Giảm âm lượng': 'Vol -',
  'Tắt tiếng': 'Mute',
  'Quay lại': 'Back',
  'Về Home': 'Home',
  'Đa nhiệm': 'Recent',
  'Tải lại stream': 'Reload stream',
  'Tải lại': 'Reload',
  'Trang shell': 'Shell page',
  'Trang danh sách file': 'File listing page',
  'Xem device riêng': 'View device (single)',
  'Chụp màn hình (tile active)': 'Screenshot (active tile)',
  'Chụp màn hình': 'Screenshot',
  'Menu': 'Menu',
  'Cài APK (device active)': 'Install APK (active device)',
  'Cài đặt': 'Settings',
  'Sync thiết bị': 'Sync devices',
  'Đang sync: {main} → {count} device phụ': 'Syncing: {main} → {count} follower device(s)',
  'Đang bật sync, chọn device chính': 'Sync is on, pick a main device',
  'Sync đang tắt': 'Sync is off',
  'Ẩn': 'Hide',
  'Bật sync': 'Turn on sync',
  'Xong': 'Done',
  'Device chính': 'Main device',
  'Device phụ (follow chính)': 'Follower devices (follow main)',
  'Chưa có tile nào': 'No tiles yet',
  'Không đặt': 'Unset',
  'Chỉ bật sync khi đã chọn device': 'Enable sync only after choosing a device',
  'Chọn tất cả device phụ': 'Select all follower devices',
  'device khả dụng': 'available device(s)',
  'Chưa có device để sync': 'No devices to sync',
  'Chọn device chính để thấy danh sách follow': 'Pick a main device to see followers',
  'Broadcast từ chính': 'Broadcast from main',
  'Follow thao tác từ chính': 'Follows actions from main',
  'Đang active': 'Active',
  'Khi sync bật: mọi thao tác trên device chính sẽ broadcast tới device phụ. Bạn có thể đóng (ẩn) hộp thoại mà sync vẫn tiếp tục.':
    'When sync is on: actions on the main device broadcast to followers. You can close/hide this dialog and sync continues.',
  '{count} device khả dụng': '{count} available device(s)',
  'Đổi ngôn ngữ': 'Change language',
  'Chính': 'Main',
  'Phụ': 'Follower',
  'Khởi tạo…': 'Init…',
  '❌ lỗi worker render YUV': '❌ yuv render worker error',
  '✅ Hiển thị ({w}x{h})': '✅ View ({w}x{h})',
  'Thay đổi xoay/kích thước - khởi động lại…': 'Rotate/resolution change - restarting…',
  '❌ lỗi worker tinyh264': '❌ tinyh264 worker error',
  'SPS đổi - khởi động lại…': 'SPS changed - restarting…',
  'PPS đổi - khởi động lại…': 'PPS changed - restarting…',
  '❌ thiếu tham số thiết bị': '❌ missing device param',
  'Đang kết nối…': 'Connecting…',
  '⏱️ tải >10s - đang reload…': '⏱️ loading >10s - reloading…',
  'WS mở → gửi config BINARY…': 'WS open → send BINARY config…',
  'Đã gửi config binary → đợi video…': 'Binary config sent → waiting video…',
  '❌ gửi config binary thất bại': '❌ send binary config failed',
  '❌ lỗi WS': '❌ WS error',
  'WS đóng ({code}{reason}) - thử lại…': 'WS closed ({code}{reason}) - retry…',
  'Đang reload…': 'Reloading…',
  '⚠️ decode đứng - kết nối lại…': '⚠️ decode stalled - reconnecting…',
  '⚠️ idle lâu - kết nối lại…': '⚠️ idle too long - reconnecting…',
  'WebSocket': 'WebSocket',
  'Thiết bị': 'Devices',
  'Ngôn ngữ': 'Language',
  'Sync': 'Sync',
  'Bật': 'On',
  'Tắt': 'Off',
  'Chưa chọn device chính': 'No main device selected',
  'Chưa chọn': 'Not selected',
  'Sync nhanh': 'Quick sync',
  'Đặt làm device chính': 'Set as main device',
  'Theo device chính': 'Follow main device',
  'Theo': 'Follow',
  'Đang chính': 'Is main',
  'Tự tính theo độ rộng': 'Auto from width',
  'Độ rộng view: {width}px': 'View width: {width}px',
  'Kéo để di chuyển tile': 'Drag to move tile',
  'Điều khiển nhanh': 'Quick controls',
  'Sync tắt': 'Sync off',
  'Đang sync': 'Sync on',
  'Device phụ': 'Follower devices',
  'Bật sync để chọn device': 'Turn on sync to select devices',
  'Không đặt device chính — mọi device sẽ điều khiển nhóm đã chọn': 'No main device — every device will control selected group',
  'Chưa có device': 'No devices yet',
  'Hiển thị tất cả': 'Show all',
  'Hiển thị đã chọn': 'Show selected',
  'Điện thoại không có thẻ (0 / 20)': 'Devices without tag (0 / 20)',
  'Đang điều khiển': 'Controlling',
  'Thiết bị đang mở trong viewer — tránh điều khiển trùng lặp': 'Device is open in viewer — avoid duplicate control',
  'Đang hiển thị trên viewer': 'Showing in viewer',
  'Đang chờ phản hồi': 'Waiting for response',
  '❌ Thất bại': '❌ Failed',
  'Đã kết nối {count} thiết bị': 'Connected {count} device(s)',
  'Kết nối {type} thất bại với {count} thiết bị': 'Connect failed for {count} {type} device(s)',
  'Kết nối {type} thất bại với {count} thiết bị: {error}':
    'Connect failed for {count} {type} device(s): {error}',
  'Kết nối thất bại: {error}': 'Connect failed: {error}',
  'Kết nối thất bại': 'Connect failed',
  'Vui lòng kiểm tra lại thiết bị đã được cắm vào máy đúng cách chưa':
    'Please check that the device is properly plugged into the host',
  'Đang tải…': 'Loading…',
};

const invert = (obj: Record<string, string>) =>
  Object.fromEntries(Object.entries(obj).map(([k, v]) => [v, k]));

// English is the source language.
const translations: Record<Locale, Record<string, string>> = {
  en: {},
  vi: invert(legacyViToEn),
  es: {
    'Tile size': 'Tamaño del tile',
    'Large size': 'Tamaño grande',
    'Decrease tile width': 'Disminuir ancho del tile',
    'Increase tile width': 'Aumentar ancho del tile',
    'Viewer width': 'Ancho del visor',
    'Decrease viewer width': 'Disminuir ancho del visor',
    'Increase viewer width': 'Aumentar ancho del visor',
    'Tile height: {height}px (Auto from width)': 'Altura del tile: {height}px (auto según ancho)',
    'Stream config (viewer)': 'Configuración de stream (visor)',
    'Stream width': 'Ancho de stream',
    'Decrease stream width': 'Disminuir ancho de stream',
    'Increase stream width': 'Aumentar ancho de stream',
    'Decrease bitrate': 'Disminuir bitrate',
    'Increase bitrate': 'Aumentar bitrate',
    'Decrease FPS': 'Disminuir FPS',
    'Increase FPS': 'Aumentar FPS',
    'Rotation lock:': 'Bloqueo de rotación:',
    'Reset to default': 'Restablecer por defecto',
    'Local': 'Local',
    'Online': 'En línea',
    'All': 'Todo',
    'Device tags': 'Etiquetas de dispositivo',
    'Add tag': 'Añadir etiqueta',
    'Select all': 'Seleccionar todo',
    'Deselect all': 'Quitar selección',
    'Expand config panel': 'Expandir panel de configuración',
    'Stream config': 'Configuración de stream',
    'Tile width: {width}px': 'Ancho del tile: {width}px',
    'Tile height: {height}px': 'Alto del tile: {height}px',
    'Bitrate: {bps} bps': 'Bitrate: {bps} bps',
    'Max FPS: {fps} fps': 'FPS máximo: {fps} fps',
    'Stream width: {width}px': 'Ancho de stream: {width}px',
    'Stream height: {height}px': 'Alto de stream: {height}px',
    'Rotated orientation:': 'Bloqueo de rotación:',
    'Reset default': 'Restaurar predeterminado',
    'High bitrate': 'Bitrate alto',
    'High bitrate (>60%) may increase load and cause stutter/interruptions. Continue?':
      'Bitrate alto (>60%) puede aumentar la carga y causar cortes. ¿Continuar?',
    'Cancel': 'Cancelar',
    'Continue': 'Continuar',
    'Pick a device before installing APK': 'Elige un dispositivo antes de instalar APK',
    'Uploading {name}...': 'Subiendo {name}...',
    'Saved to server: {name}, installing...': 'Guardado en servidor: {name}, instalando...',
    'Installed: {name}': 'Instalado: {name}',
    'Install/Upload APK failed': 'Falló instalar/subir APK',
    'Sync on: send actions to all open devices': 'Sync activado: envía acciones a todos los dispositivos abiertos',
    'Sync off: control only the focused device': 'Sync desactivado: controla solo el dispositivo con foco',
    'Stop sync': 'Detener sync',
    'Power': 'Encendido/Apagado',
    'Vol +': 'Volumen +',
    'Vol -': 'Volumen -',
    'Mute': 'Silencio',
    'Back': 'Atrás',
    'Home': 'Inicio',
    'Recent': 'Recientes',
    'Reload stream': 'Recargar stream',
    'Reload': 'Recargar',
    'Shell page': 'Página shell',
    'File listing page': 'Página de archivos',
    'View device (single)': 'Ver dispositivo (solo)',
    'Screenshot (active tile)': 'Captura (tile activo)',
    'Screenshot': 'Captura de pantalla',
    'Menu': 'Menú',
    'Install APK (active device)': 'Instalar APK (dispositivo activo)',
    'Settings': 'Ajustes',
    'Sync devices': 'Sincronizar dispositivos',
    'Syncing: {main} → {count} follower device(s)': 'Sincronizando: {main} → {count} seguidor(es)',
    'Sync is on, pick a main device': 'Sync activado, elige dispositivo principal',
    'Sync is off': 'Sync desactivado',
    'Hide': 'Ocultar',
    'Turn on sync': 'Activar sync',
    'Done': 'Listo',
    'Main device': 'Dispositivo principal',
    'Follower devices (follow main)': 'Dispositivos seguidores (siguen al principal)',
    'No tiles yet': 'Aún no hay tiles',
    'Unset': 'Sin definir',
    'Enable sync only after choosing a device': 'Activa sync solo tras elegir dispositivo',
    'Select all follower devices': 'Seleccionar todos los dispositivos seguidores',
    'available device(s)': 'dispositivo(s) disponible(s)',
    'No devices to sync': 'No hay dispositivos para sync',
    'Pick a main device to see followers': 'Elige dispositivo principal para ver seguidores',
    'Broadcast from main': 'Emitir desde principal',
    'Follows actions from main': 'Sigue acciones del principal',
    'Active': 'Activo',
    'When sync is on: actions on the main device broadcast to followers. You can close/hide this dialog and sync continues.':
      'Cuando sync está activo: las acciones en el principal se envían a los seguidores. Puedes cerrar/ocultar este diálogo y sync continúa.',
    '{count} available device(s)': '{count} dispositivo(s) disponible(s)',
    'Change language': 'Cambiar idioma',
    'Main': 'Principal',
    'Follower': 'Seguidor',
    'Init…': 'Iniciando…',
    '❌ yuv render worker error': 'Error del worker YUV',
    '✅ View ({w}x{h})': '✅ Vista ({w}x{h})',
    'Rotate/resolution change - restarting…': 'Cambio de rotación/resolución - reiniciando…',
    '❌ tinyh264 worker error': 'Error del worker tinyh264',
    'SPS changed - restarting…': 'SPS cambió - reiniciando…',
    'PPS changed - restarting…': 'PPS cambió - reiniciando…',
    '❌ missing device param': 'Falta parámetro de dispositivo',
    'Connecting…': 'Conectando…',
    '⏱️ loading >10s - reloading…': '⏱️ cargando >10s - recargando…',
    'WS open → send BINARY config…': 'WS abierto → enviando config BINARIA…',
    'Binary config sent → waiting video…': 'Config binaria enviada → esperando video…',
    '❌ send binary config failed': 'Falló enviar config binaria',
    '❌ WS error': 'Error de WS',
    'WS closed ({code}{reason}) - retry…': 'WS cerrado ({code}{reason}) - reintentar…',
    'Reloading…': 'Recargando…',
    '⚠️ decode stalled - reconnecting…': '⚠️ decodificación detenida - reconectando…',
    '⚠️ idle too long - reconnecting…': '⚠️ inactividad prolongada - reconectando…',
    'WebSocket': 'WebSocket',
    'Devices': 'Dispositivos',
    'Language': 'Idioma',
    'Sync': 'Sync',
    'On': 'Encendido',
    'Off': 'Apagado',
    'No main device selected': 'No se seleccionó principal',
    'Not selected': 'Sin seleccionar',
    'Quick sync': 'Sync rápido',
    'Set as main device': 'Establecer como principal',
    'Follow main device': 'Seguir principal',
    'Follow': 'Seguir',
    'Is main': 'Es principal',
    'Auto from width': 'Auto según ancho',
    'View width: {width}px': 'Ancho de vista: {width}px',
    'Drag to move tile': 'Arrastra para mover tile',
    'Quick controls': 'Controles rápidos',
    'Sync off': 'Sync desactivado',
    'Sync on': 'Sync activado',
    'Follower devices': 'Dispositivos seguidores',
    'Turn on sync to select devices': 'Activa sync para seleccionar dispositivos',
    'Show all': 'Mostrar todos',
    'Show selected': 'Mostrar seleccionados',
    'Devices without tag (0 / 20)': 'Dispositivos sin etiqueta (0 / 20)',
    'Controlling': 'Controlando',
    'Device is open in viewer — avoid duplicate control': 'El dispositivo está abierto en el visor — evita controlar duplicado',
    'Showing in viewer': 'Mostrando en el visor',
    'Waiting for response': 'Esperando respuesta',
    '❌ Failed': '❌ Falló',
  },
  fr: {
    'Tile size': 'Taille du tile',
    'Large size': 'Grande taille',
    'Decrease tile width': 'Diminuer la largeur du tile',
    'Increase tile width': 'Augmenter la largeur du tile',
    'Viewer width': 'Largeur du viewer',
    'Decrease viewer width': 'Réduire la largeur du viewer',
    'Increase viewer width': 'Augmenter la largeur du viewer',
    'Tile height: {height}px (Auto from width)': 'Hauteur du tile : {height}px (auto depuis la largeur)',
    'Stream config (viewer)': 'Configuration du stream (viewer)',
    'Stream width': 'Largeur du stream',
    'Decrease stream width': 'Réduire la largeur du stream',
    'Increase stream width': 'Augmenter la largeur du stream',
    'Decrease bitrate': 'Réduire le bitrate',
    'Increase bitrate': 'Augmenter le bitrate',
    'Decrease FPS': 'Réduire les FPS',
    'Increase FPS': 'Augmenter les FPS',
    'Rotation lock:': 'Verrouillage rotation :',
    'Reset to default': 'Réinitialiser',
    'Local': 'Local',
    'Online': 'En ligne',
    'All': 'Tous',
    'Device tags': 'Tags de l’appareil',
    'Add tag': 'Ajouter un tag',
    'Select all': 'Tout sélectionner',
    'Deselect all': 'Tout désélectionner',
    'Expand config panel': 'Développer le panneau de config',
    'Stream config': 'Configuration du stream',
    'Tile width: {width}px': 'Largeur du tile : {width}px',
    'Tile height: {height}px': 'Hauteur du tile : {height}px',
    'Bitrate: {bps} bps': 'Débit : {bps} bps',
    'Max FPS: {fps} fps': 'FPS max : {fps} fps',
    'Stream width: {width}px': 'Largeur du stream : {width}px',
    'Stream height: {height}px': 'Hauteur du stream : {height}px',
    'Rotated orientation:': 'Verrouillage rotation :',
    'Reset default': 'Réinitialiser',
    'High bitrate': 'Débit élevé',
    'High bitrate (>60%) may increase load and cause stutter/interruptions. Continue?':
      'Un débit élevé (>60%) peut augmenter la charge et provoquer des saccades. Continuer ?',
    'Cancel': 'Annuler',
    'Continue': 'Continuer',
    'Pick a device before installing APK': 'Choisissez un appareil avant d’installer l’APK',
    'Uploading {name}...': 'Envoi de {name}...',
    'Saved to server: {name}, installing...': 'Enregistré sur le serveur : {name}, installation...',
    'Installed: {name}': '{name} installé',
    'Install/Upload APK failed': "Échec de l'installation/envoi de l’APK",
    'Sync on: send actions to all open devices': 'Sync activé : envoie les actions à tous les appareils ouverts',
    'Sync off: control only the focused device': 'Sync désactivé : contrôle uniquement l’appareil actif',
    'Stop sync': 'Arrêter la sync',
    'Power': 'Alimentation',
    'Vol +': 'Volume +',
    'Vol -': 'Volume -',
    'Mute': 'Muet',
    'Back': 'Retour',
    'Home': 'Accueil',
    'Recent': 'Récents',
    'Reload stream': 'Recharger le stream',
    'Reload': 'Recharger',
    'Shell page': 'Page shell',
    'File listing page': 'Page des fichiers',
    'View device (single)': 'Voir l’appareil (solo)',
    'Screenshot (active tile)': 'Capture (tile actif)',
    'Screenshot': 'Capture d’écran',
    'Menu': 'Menu',
    'Install APK (active device)': 'Installer APK (appareil actif)',
    'Settings': 'Réglages',
    'Sync devices': 'Synchroniser les appareils',
    'Syncing: {main} → {count} follower device(s)': 'Sync en cours : {main} → {count} suiveur(s)',
    'Sync is on, pick a main device': 'Sync activé, choisissez un appareil principal',
    'Sync is off': 'Sync désactivé',
    'Hide': 'Masquer',
    'Turn on sync': 'Activer la sync',
    'Done': 'Terminé',
    'Main device': 'Appareil principal',
    'Follower devices (follow main)': 'Appareils suiveurs (suivent le principal)',
    'No tiles yet': 'Aucun tile pour l’instant',
    'Unset': 'Non défini',
    'Enable sync only after choosing a device': 'Activez la sync après avoir choisi un appareil',
    'Select all follower devices': 'Sélectionner tous les suiveurs',
    'available device(s)': 'appareil(s) disponible(s)',
    'No devices to sync': 'Aucun appareil à synchroniser',
    'Pick a main device to see followers': 'Choisissez un principal pour voir les suiveurs',
    'Broadcast from main': 'Diffusion depuis le principal',
    'Follows actions from main': 'Suit les actions du principal',
    'Active': 'Actif',
    'When sync is on: actions on the main device broadcast to followers. You can close/hide this dialog and sync continues.':
      'Quand la sync est activée : les actions du principal sont diffusées aux suiveurs. Vous pouvez fermer/masquer ce dialogue, la sync continue.',
    '{count} available device(s)': '{count} appareil(s) disponible(s)',
    'Change language': 'Changer de langue',
    'Main': 'Principal',
    'Follower': 'Suiveur',
    'Init…': 'Initialisation…',
    '❌ yuv render worker error': 'Erreur worker rendu YUV',
    '✅ View ({w}x{h})': '✅ Vue ({w}x{h})',
    'Rotate/resolution change - restarting…': 'Changement rotation/résolution - redémarrage…',
    '❌ tinyh264 worker error': 'Erreur worker tinyh264',
    'SPS changed - restarting…': 'SPS modifié - redémarrage…',
    'PPS changed - restarting…': 'PPS modifié - redémarrage…',
    '❌ missing device param': 'Paramètre appareil manquant',
    'Connecting…': 'Connexion…',
    '⏱️ loading >10s - reloading…': '⏱️ chargement >10s - rechargement…',
    'WS open → send BINARY config…': 'WS ouvert → envoi de la config BINAIRE…',
    'Binary config sent → waiting video…': 'Config binaire envoyée → attente vidéo…',
    '❌ send binary config failed': "Échec d'envoi de la config binaire",
    '❌ WS error': 'Erreur WS',
    'WS closed ({code}{reason}) - retry…': 'WS fermé ({code}{reason}) - nouvelle tentative…',
    'Reloading…': 'Rechargement…',
    '⚠️ decode stalled - reconnecting…': '⚠️ décodage bloqué - reconnexion…',
    '⚠️ idle too long - reconnecting…': '⚠️ inactivité prolongée - reconnexion…',
    'WebSocket': 'WebSocket',
    'Devices': 'Appareils',
    'Language': 'Langue',
    'Sync': 'Sync',
    'On': 'Activé',
    'Off': 'Désactivé',
    'No main device selected': 'Aucun principal sélectionné',
    'Not selected': 'Non sélectionné',
    'Quick sync': 'Sync rapide',
    'Set as main device': 'Définir comme principal',
    'Follow main device': 'Suivre le principal',
    'Follow': 'Suivre',
    'Is main': 'Est principal',
    'Auto from width': 'Auto selon la largeur',
    'View width: {width}px': 'Largeur de vue : {width}px',
    'Drag to move tile': 'Glisser pour déplacer le tile',
    'Quick controls': 'Contrôles rapides',
    'Sync off': 'Sync désactivée',
    'Sync on': 'Sync activée',
    'Follower devices': 'Appareils suiveurs',
    'Turn on sync to select devices': 'Activez la sync pour sélectionner des appareils',
    'Show all': 'Tout afficher',
    'Show selected': 'Afficher sélection',
    'Devices without tag (0 / 20)': 'Appareils sans étiquette (0 / 20)',
    'Controlling': 'Contrôle en cours',
    'Device is open in viewer — avoid duplicate control': 'Appareil ouvert dans le viewer — éviter le double contrôle',
    'Showing in viewer': 'Affiché dans le viewer',
    'Waiting for response': 'En attente de réponse',
    '❌ Failed': '❌ Échec',
  },
  ja: {
    'Tile size': 'タイルサイズ',
    'Large size': '大きさ',
    'Decrease tile width': 'タイル幅を縮小',
    'Increase tile width': 'タイル幅を拡大',
    'Viewer width': 'ビューア幅',
    'Decrease viewer width': 'ビューア幅を縮小',
    'Increase viewer width': 'ビューア幅を拡大',
    'Tile height: {height}px (Auto from width)': 'タイル高さ: {height}px（幅から自動計算）',
    'Stream config (viewer)': 'ストリーム設定（ビューア）',
    'Stream width': 'ストリーム幅',
    'Decrease stream width': 'ストリーム幅を縮小',
    'Increase stream width': 'ストリーム幅を拡大',
    'Decrease bitrate': 'ビットレートを下げる',
    'Increase bitrate': 'ビットレートを上げる',
    'Decrease FPS': 'FPSを下げる',
    'Increase FPS': 'FPSを上げる',
    'Rotation lock:': '回転ロック:',
    'Reset to default': 'デフォルトに戻す',
    'Local': 'ローカル',
    'Online': 'オンライン',
    'All': 'すべて',
    'Device tags': 'デバイスタグ',
    'Add tag': 'タグを追加',
    'Select all': 'すべて選択',
    'Deselect all': '選択を解除',
    'Expand config panel': '設定パネルを展開',
    'Stream config': 'ストリーム設定',
    'Tile width: {width}px': 'タイル幅: {width}px',
    'Tile height: {height}px': 'タイル高さ: {height}px',
    'Bitrate: {bps} bps': 'ビットレート: {bps} bps',
    'Max FPS: {fps} fps': '最大FPS: {fps} fps',
    'Stream width: {width}px': 'ストリーム幅: {width}px',
    'Stream height: {height}px': 'ストリーム高さ: {height}px',
    'Rotated orientation:': '回転ロック:',
    'Reset default': 'デフォルトに戻す',
    'High bitrate': '高ビットレート',
    'High bitrate (>60%) may increase load and cause stutter/interruptions. Continue?':
      '高ビットレート（>60%）は負荷を増やし、途切れの原因になります。続行しますか？',
    'Cancel': 'キャンセル',
    'Continue': '続行',
    'Pick a device before installing APK': 'APKをインストールする前にデバイスを選択してください',
    'Uploading {name}...': '{name} をアップロード中…',
    'Saved to server: {name}, installing...': 'サーバーに保存済み: {name}、インストール中…',
    'Installed: {name}': 'インストール完了: {name}',
    'Install/Upload APK failed': 'APKのアップロード/インストールに失敗しました',
    'Sync on: send actions to all open devices': '同期オン: 開いている全デバイスへ操作を送信',
    'Sync off: control only the focused device': '同期オフ: フォーカス中デバイスのみ操作',
    'Stop sync': '同期を停止',
    'Power': '電源',
    'Vol +': '音量＋',
    'Vol -': '音量－',
    'Mute': 'ミュート',
    'Back': '戻る',
    'Home': 'ホーム',
    'Recent': '履歴',
    'Reload stream': 'ストリーム再読み込み',
    'Reload': '再読み込み',
    'Shell page': 'シェルページ',
    'File listing page': 'ファイル一覧ページ',
    'View device (single)': 'デバイスを単体表示',
    'Screenshot (active tile)': 'スクリーンショット（アクティブタイル）',
    'Screenshot': 'スクリーンショット',
    'Menu': 'メニュー',
    'Install APK (active device)': 'APKをインストール（アクティブデバイス）',
    'Settings': '設定',
    'Sync devices': 'デバイス同期',
    'Syncing: {main} → {count} follower device(s)': '同期中: {main} → {count} 台のフォロワー',
    'Sync is on, pick a main device': '同期オン、メインデバイスを選択してください',
    'Sync is off': '同期オフ',
    'Hide': '非表示',
    'Turn on sync': '同期をオンにする',
    'Done': '完了',
    'Main device': 'メインデバイス',
    'Follower devices (follow main)': 'フォロワーデバイス（メインをフォロー）',
    'No tiles yet': 'まだタイルがありません',
    'Unset': '未設定',
    'Enable sync only after choosing a device': 'デバイス選択後に同期を有効にしてください',
    'Select all follower devices': 'すべてのフォロワーを選択',
    'available device(s)': '利用可能なデバイス',
    'No devices to sync': '同期するデバイスがありません',
    'Pick a main device to see followers': 'メインデバイスを選ぶとフォロワーが表示されます',
    'Broadcast from main': 'メインからブロードキャスト',
    'Follows actions from main': 'メインの操作に追従',
    'Active': 'アクティブ',
    'When sync is on: actions on the main device broadcast to followers. You can close/hide this dialog and sync continues.':
      '同期オンのとき、メインの操作はフォロワーへ送信されます。ダイアログを閉じても同期は続行されます。',
    '{count} available device(s)': '{count} 台利用可能',
    'Change language': '言語を変更',
    'Main': 'メイン',
    'Follower': 'フォロワー',
    'Init…': '初期化中…',
    '❌ yuv render worker error': '❌ YUVレンダー worker エラー',
    '✅ View ({w}x{h})': '✅ 表示 ({w}x{h})',
    'Rotate/resolution change - restarting…': '回転/解像度変更 - 再起動中…',
    '❌ tinyh264 worker error': '❌ tinyh264 worker エラー',
    'SPS changed - restarting…': 'SPS 変更 - 再起動中…',
    'PPS changed - restarting…': 'PPS 変更 - 再起動中…',
    '❌ missing device param': '❌ デバイスパラメータが不足',
    'Connecting…': '接続中…',
    '⏱️ loading >10s - reloading…': '⏱️ 10秒超で読み込み中 - 再読み込み…',
    'WS open → send BINARY config…': 'WS接続 → バイナリ設定送信…',
    'Binary config sent → waiting video…': 'バイナリ設定送信済み → 映像待ち…',
    '❌ send binary config failed': '❌ バイナリ設定送信失敗',
    '❌ WS error': '❌ WSエラー',
    'WS closed ({code}{reason}) - retry…': 'WS切断 ({code}{reason}) - 再試行…',
    'Reloading…': '再読み込み中…',
    '⚠️ decode stalled - reconnecting…': '⚠️ デコード停止 - 再接続…',
    '⚠️ idle too long - reconnecting…': '⚠️ 長時間アイドル - 再接続…',
    'WebSocket': 'WebSocket',
    'Devices': 'デバイス',
    'Language': '言語',
    'Sync': '同期',
    'On': 'オン',
    'Off': 'オフ',
    'No main device selected': 'メインデバイス未選択',
    'Not selected': '未選択',
    'Quick sync': 'クイック同期',
    'Set as main device': 'メインに設定',
    'Follow main device': 'メインに追従',
    'Follow': '追従',
    'Is main': 'メインです',
    'Auto from width': '幅から自動計算',
    'View width: {width}px': '表示幅: {width}px',
    'Drag to move tile': 'ドラッグでタイル移動',
    'Quick controls': 'クイック操作',
    'Sync off': '同期オフ',
    'Sync on': '同期オン',
    'Follower devices': 'フォロワーデバイス',
    'Turn on sync to select devices': '同期をオンにしてデバイスを選択',
    'Show all': 'すべて表示',
    'Show selected': '選択のみ表示',
    'Devices without tag (0 / 20)': 'タグなしデバイス (0 / 20)',
    'Controlling': '操作中',
    'Device is open in viewer — avoid duplicate control': 'デバイスがビューアで開いています — 二重操作に注意',
    'Showing in viewer': 'ビューアで表示中',
    'Waiting for response': '応答待ち',
    '❌ Failed': '❌ 失敗',
  },
  ko: {
    'Tile size': '타일 크기',
    'Large size': '큰 크기',
    'Decrease tile width': '타일 너비 줄이기',
    'Increase tile width': '타일 너비 늘리기',
    'Viewer width': '뷰어 너비',
    'Decrease viewer width': '뷰어 너비 줄이기',
    'Increase viewer width': '뷰어 너비 늘리기',
    'Tile height: {height}px (Auto from width)': '타일 높이: {height}px (너비 기준 자동)',
    'Stream config (viewer)': '스트림 설정(뷰어)',
    'Stream width': '스트림 너비',
    'Decrease stream width': '스트림 너비 줄이기',
    'Increase stream width': '스트림 너비 늘리기',
    'Decrease bitrate': '비트레이트 낮추기',
    'Increase bitrate': '비트레이트 높이기',
    'Decrease FPS': 'FPS 낮추기',
    'Increase FPS': 'FPS 높이기',
    'Rotation lock:': '회전 잠금:',
    'Reset to default': '기본값으로 재설정',
    'Local': '로컬',
    'Online': '온라인',
    'All': '전체',
    'Device tags': '디바이스 태그',
    'Add tag': '태그 추가',
    'Select all': '전체 선택',
    'Deselect all': '선택 해제',
    'Expand config panel': '설정 패널 펼치기',
    'Stream config': '스트림 설정',
    'Tile width: {width}px': '타일 너비: {width}px',
    'Tile height: {height}px': '타일 높이: {height}px',
    'Bitrate: {bps} bps': '비트레이트: {bps} bps',
    'Max FPS: {fps} fps': '최대 FPS: {fps} fps',
    'Stream width: {width}px': '스트림 너비: {width}px',
    'Stream height: {height}px': '스트림 높이: {height}px',
    'Rotated orientation:': '회전 잠금:',
    'Reset default': '기본값으로 복원',
    'High bitrate': '높은 비트레이트',
    'High bitrate (>60%) may increase load and cause stutter/interruptions. Continue?':
      '높은 비트레이트(>60%)는 부하와 끊김을 유발할 수 있습니다. 계속할까요?',
    'Cancel': '취소',
    'Continue': '계속',
    'Pick a device before installing APK': 'APK 설치 전에 기기를 선택하세요',
    'Uploading {name}...': '{name} 업로드 중…',
    'Saved to server: {name}, installing...': '서버에 저장됨: {name}, 설치 중…',
    'Installed: {name}': '설치 완료: {name}',
    'Install/Upload APK failed': 'APK 업로드/설치 실패',
    'Sync on: send actions to all open devices': '동기화 켜짐: 열린 모든 기기로 동작 전송',
    'Sync off: control only the focused device': '동기화 꺼짐: 포커스된 기기만 제어',
    'Stop sync': '동기화 중지',
    'Power': '전원',
    'Vol +': '볼륨 +',
    'Vol -': '볼륨 -',
    'Mute': '음소거',
    'Back': '뒤로',
    'Home': '홈',
    'Recent': '최근 앱',
    'Reload stream': '스트림 새로고침',
    'Reload': '새로고침',
    'Shell page': '셸 페이지',
    'File listing page': '파일 목록 페이지',
    'View device (single)': '기기 단독 보기',
    'Screenshot (active tile)': '스크린샷(활성 타일)',
    'Screenshot': '스크린샷',
    'Menu': '메뉴',
    'Install APK (active device)': 'APK 설치(활성 기기)',
    'Settings': '설정',
    'Sync devices': '기기 동기화',
    'Syncing: {main} → {count} follower device(s)': '동기화 중: {main} → {count} 기기',
    'Sync is on, pick a main device': '동기화 켜짐, 메인 기기를 선택하세요',
    'Sync is off': '동기화 꺼짐',
    'Hide': '숨기기',
    'Turn on sync': '동기화 켜기',
    'Done': '완료',
    'Main device': '메인 기기',
    'Follower devices (follow main)': '팔로워 기기(메인을 따름)',
    'No tiles yet': '타일이 없습니다',
    'Unset': '미설정',
    'Enable sync only after choosing a device': '기기 선택 후 동기화를 켜세요',
    'Select all follower devices': '모든 팔로워 선택',
    'available device(s)': '사용 가능 기기',
    'No devices to sync': '동기화할 기기가 없습니다',
    'Pick a main device to see followers': '팔로워를 보려면 메인 기기를 선택하세요',
    'Broadcast from main': '메인에서 브로드캐스트',
    'Follows actions from main': '메인의 동작을 따름',
    'Active': '활성',
    'When sync is on: actions on the main device broadcast to followers. You can close/hide this dialog and sync continues.':
      '동기화가 켜져 있으면 메인 기기의 동작이 팔로워로 전송됩니다. 대화상자를 닫아도 동기화는 계속됩니다.',
    '{count} available device(s)': '사용 가능 {count}대',
    'Change language': '언어 변경',
    'Main': '메인',
    'Follower': '팔로워',
    'Init…': '초기화 중…',
    '❌ yuv render worker error': '❌ YUV 렌더 worker 오류',
    '✅ View ({w}x{h})': '✅ 보기 ({w}x{h})',
    'Rotate/resolution change - restarting…': '회전/해상도 변경 - 재시작 중…',
    '❌ tinyh264 worker error': '❌ tinyh264 worker 오류',
    'SPS changed - restarting…': 'SPS 변경 - 재시작 중…',
    'PPS changed - restarting…': 'PPS 변경 - 재시작 중…',
    '❌ missing device param': '❌ 기기 파라미터 누락',
    'Connecting…': '연결 중…',
    '⏱️ loading >10s - reloading…': '⏱️ 10초 이상 로딩 - 재시도…',
    'WS open → send BINARY config…': 'WS 연결됨 → 바이너리 설정 전송…',
    'Binary config sent → waiting video…': '바이너리 설정 전송 완료 → 영상 대기…',
    '❌ send binary config failed': '❌ 바이너리 설정 전송 실패',
    '❌ WS error': '❌ WS 오류',
    'WS closed ({code}{reason}) - retry…': 'WS 종료 ({code}{reason}) - 재시도…',
    'Reloading…': '재로딩…',
    '⚠️ decode stalled - reconnecting…': '⚠️ 디코드 중단 - 재연결…',
    '⚠️ idle too long - reconnecting…': '⚠️ 장시간 대기 - 재연결…',
    'WebSocket': '웹소켓',
    'Devices': '기기',
    'Language': '언어',
    'Sync': '동기화',
    'On': '켜짐',
    'Off': '꺼짐',
    'No main device selected': '메인 기기 미선택',
    'Not selected': '선택 안 함',
    'Quick sync': '빠른 동기화',
    'Set as main device': '메인으로 설정',
    'Follow main device': '메인을 따르기',
    'Follow': '따르기',
    'Is main': '메인임',
    'Auto from width': '너비 기준 자동',
    'View width: {width}px': '보기 너비: {width}px',
    'Drag to move tile': '드래그하여 타일 이동',
    'Quick controls': '빠른 제어',
    'Sync off': '동기화 꺼짐',
    'Sync on': '동기화 켜짐',
    'Follower devices': '팔로워 기기',
    'Turn on sync to select devices': '동기화를 켜서 기기를 선택하세요',
    'Show all': '모두 보기',
    'Show selected': '선택만 보기',
    'Devices without tag (0 / 20)': '태그 없는 기기 (0 / 20)',
    'Controlling': '제어 중',
    'Device is open in viewer — avoid duplicate control': '뷰어에서 열려 있음 — 중복 제어를 피하세요',
    'Showing in viewer': '뷰어에 표시 중',
    'Waiting for response': '응답 대기 중',
    '❌ Failed': '❌ 실패',
  },
};

function format(msg: string, params?: Record<string, any>) {
  if (!params) return msg;
  return msg.replace(/\{(\w+)\}/g, (_m, k) => {
    const v = params[k];
    return v === undefined || v === null ? '' : String(v);
  });
}

const Ctx = createContext<I18nContextValue | null>(null);

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const readInitial = (): Locale => {
    try {
      const saved = localStorage.getItem('locale') as Locale | null;
      if (saved && ['en', 'vi', 'es', 'fr', 'ja', 'ko'].includes(saved)) {
        return saved as Locale;
      }
    } catch {
      // ignore
    }
    return 'en';
  };

  const [locale, setLocale] = useState<Locale>(readInitial);

  const updateLocale = useCallback((l: Locale) => {
    setLocale(l);
    try {
      localStorage.setItem('locale', l);
    } catch {
      // ignore
    }
  }, []);

  // Accept English keys as source. For backward compatibility,
  // if a Vietnamese key is passed, map it to English via legacy map.
  const t = useCallback(
    (message: string, params?: Record<string, any>) => {
      const messageEn = legacyViToEn[message] ?? message; // ensure English source
      const template =
        translations[locale]?.[messageEn] ??
        // If caller passed Vietnamese and locale is vi, keep original
        (locale === 'vi' && legacyViToEn[message] ? message : messageEn);
      return format(template, params);
    },
    [locale],
  );

  const value = useMemo<I18nContextValue>(
    () => ({
      locale,
      setLocale: updateLocale,
      available: ['en', 'vi', 'es', 'fr', 'ja', 'ko'],
      t,
    }),
    [locale, updateLocale, t],
  );

  return <Ctx.Provider value={value}>{children}</Ctx.Provider>;
}

export function useI18n() {
  const v = useContext(Ctx);
  if (!v) throw new Error('useI18n must be used inside I18nProvider');
  return v;
}
